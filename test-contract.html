<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataToZeroAddress åˆçº¦æµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@4.2.0/dist/web3.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }

        .network-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }

        .contract-info {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #28a745;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: #fafafa;
        }

        .section h3 {
            color: #495057;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .section h3::before {
            content: "ğŸ”§";
            margin-right: 10px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #495057;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .input-group textarea {
            height: 100px;
            resize: vertical;
        }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #0056b3;
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .status.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .result-box {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .method-call-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .method-call-item h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }

        .method-detail {
            margin: 5px 0;
            font-size: 14px;
        }

        .method-detail strong {
            color: #007bff;
        }

        .events-log {
            max-height: 200px;
            overflow-y: auto;
            background: #000;
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .wallet-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
        }

        .status-indicator.connected {
            background: #28a745;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .loading {
            animation: pulse 1.5s infinite;
        }

        .copy-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }

        .copy-btn:hover {
            background: #5a6268;
        }

        .debug-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .debug-section h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .debug-info {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”— DataToZeroAddress åˆçº¦æµ‹è¯•é¡µé¢</h1>
            <p>åœ¨ Monad Testnet ä¸Šæµ‹è¯•ä½ çš„æ™ºèƒ½åˆçº¦</p>
        </div>

        <!-- è°ƒè¯•ä¿¡æ¯åŒºåŸŸ -->
        <div class="debug-section">
            <h3>ğŸ› è°ƒè¯•ä¿¡æ¯</h3>
            <div class="debug-info" id="debugInfo">ç­‰å¾…è¿æ¥...</div>
            <button class="btn btn-warning" id="checkConnectionBtn">æ£€æŸ¥è¿æ¥</button>
            <button class="btn btn-danger" id="resetConnectionBtn">é‡ç½®è¿æ¥</button>
        </div>

        <!-- ç½‘ç»œä¿¡æ¯ -->
        <div class="network-info">
            <h3>ğŸŒ ç½‘ç»œé…ç½®</h3>
            <div><strong>ç½‘ç»œ:</strong> Monad Testnet</div>
            <div><strong>Chain ID:</strong> 10143 (0x279F)</div>
            <div><strong>RPC:</strong> https://testnet-rpc.monad.xyz</div>
            <div><strong>æµè§ˆå™¨:</strong> <a href="https://testnet.monadexplorer.com/" target="_blank">Monad Explorer</a>
            </div>
        </div>

        <!-- åˆçº¦ä¿¡æ¯ -->
        <div class="contract-info">
            <h3>ğŸ“„ åˆçº¦ä¿¡æ¯</h3>
            <div><strong>åˆçº¦åœ°å€:</strong> 0x74e3fe893E71444a7e53024C93EFfe8397CD41dB <button class="copy-btn"
                    onclick="copyToClipboard('0x74e3fe893E71444a7e53024C93EFfe8397CD41dB')">å¤åˆ¶</button></div>
            <div><strong>æµè§ˆå™¨é“¾æ¥:</strong> <a
                    href="https://testnet.monadexplorer.com/address/0x74e3fe893E71444a7e53024C93EFfe8397CD41dB"
                    target="_blank">æŸ¥çœ‹åˆçº¦</a></div>
            <div><strong>éƒ¨ç½²çŠ¶æ€:</strong> âœ… å·²æˆåŠŸéƒ¨ç½²</div>
        </div>

        <!-- é’±åŒ…è¿æ¥çŠ¶æ€ -->
        <div class="wallet-status">
            <div class="status-indicator" id="walletIndicator"></div>
            <span id="walletStatus">æœªè¿æ¥é’±åŒ…</span>
            <button class="btn btn-success" id="connectWallet">è¿æ¥ MetaMask</button>
        </div>

        <!-- åˆçº¦é…ç½® -->
        <div class="section">
            <h3>âš™ï¸ åˆçº¦é…ç½®</h3>
            <div class="input-group">
                <label for="contractAddress">åˆçº¦åœ°å€:</label>
                <input type="text" id="contractAddress" value="0x74e3fe893E71444a7e53024C93EFfe8397CD41dB" readonly
                    style="background-color: #f8f9fa;">
            </div>
            <button class="btn" id="loadContract">åŠ è½½åˆçº¦</button>
            <button class="btn btn-warning" id="testContractBtn">æµ‹è¯•åˆçº¦è¿æ¥</button>
            <div id="contractStatus"></div>
        </div>

        <!-- å­˜å‚¨æ•°æ® -->
        <div class="section">
            <h3>ğŸ“ å­˜å‚¨æ•°æ®</h3>
            <div class="input-group">
                <label for="dataInput">è¦å­˜å‚¨çš„æ•°æ®:</label>
                <textarea id="dataInput"
                    placeholder="è¾“å…¥ä»»ä½•æ–‡æœ¬æ•°æ®ï¼Œå°†è¢«è½¬æ¢ä¸º bytes å­˜å‚¨åˆ°åˆçº¦ä¸­&#10;&#10;è¯•è¯•è¿™äº›ç¤ºä¾‹ï¼š&#10;- Hello Monad!&#10;- æˆ‘çš„ç¬¬ä¸€ä¸ªæ™ºèƒ½åˆçº¦æµ‹è¯•&#10;- æ—¶é—´æˆ³: 2024-01-01&#10;- JSONæ•°æ®: {&quot;name&quot;: &quot;test&quot;, &quot;value&quot;: 123}"></textarea>
            </div>
            <div class="input-group">
                <label for="gasLimitInput">Gas é™åˆ¶:</label>
                <input type="number" id="gasLimitInput" value="1000000" min="100000" max="5000000">
            </div>
            <button class="btn" id="storeDataBtn" disabled>å­˜å‚¨æ•°æ® (é«˜çº§)</button>
            <button class="btn btn-success" id="simpleStoreBtn" disabled>ç®€å•å­˜å‚¨</button>
            <button class="btn btn-warning" id="estimateGasBtn" disabled>ä¼°ç®— Gas</button>
            <div id="storeResult"></div>
        </div>

        <!-- æŸ¥è¯¢å•ä¸ªè°ƒç”¨ -->
        <div class="section">
            <h3>ğŸ” æŸ¥è¯¢æ–¹æ³•è°ƒç”¨</h3>
            <div class="input-group">
                <label for="indexInput">è°ƒç”¨ç´¢å¼•:</label>
                <input type="number" id="indexInput" min="0" placeholder="è¾“å…¥è¦æŸ¥è¯¢çš„è°ƒç”¨ç´¢å¼• (ä»0å¼€å§‹)">
            </div>
            <button class="btn btn-warning" id="getMethodCallBtn" disabled>æŸ¥è¯¢è°ƒç”¨</button>
            <button class="btn btn-warning" id="getLatestBtn" disabled>æŸ¥è¯¢æœ€æ–°</button>
            <div id="methodCallResult"></div>
        </div>

        <!-- æŸ¥è¯¢æ‰€æœ‰è°ƒç”¨ -->
        <div class="section">
            <h3>ğŸ“‹ æ‰€æœ‰æ–¹æ³•è°ƒç”¨</h3>
            <button class="btn btn-warning" id="getAllCallsBtn" disabled>è·å–æ‰€æœ‰è°ƒç”¨</button>
            <button class="btn" id="refreshCallsBtn" disabled>åˆ·æ–°</button>
            <div id="allCallsResult"></div>
        </div>

        <!-- äº‹ä»¶ç›‘å¬ -->
        <div class="section">
            <h3>ğŸ“¡ äº‹ä»¶ç›‘å¬</h3>
            <button class="btn" id="startListeningBtn" disabled>å¼€å§‹ç›‘å¬äº‹ä»¶</button>
            <button class="btn" id="stopListeningBtn" disabled>åœæ­¢ç›‘å¬</button>
            <button class="btn" id="clearEventsBtn">æ¸…é™¤äº‹ä»¶æ—¥å¿—</button>
            <div class="events-log" id="eventsLog">ç­‰å¾…äº‹ä»¶...</div>
        </div>
    </div>

    <script>
        // åˆçº¦åœ°å€ - ä½ çš„éƒ¨ç½²åœ°å€
        const CONTRACT_ADDRESS = '0x74e3fe893E71444a7e53024C93EFfe8397CD41dB';

        // åˆçº¦ ABI
        const contractABI = [
            {
                "inputs": [
                    {
                        "internalType": "bytes",
                        "name": "_data",
                        "type": "bytes"
                    }
                ],
                "name": "storeData",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_index",
                        "type": "uint256"
                    }
                ],
                "name": "getMethodCall",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "caller",
                        "type": "address"
                    },
                    {
                        "internalType": "string",
                        "name": "methodName",
                        "type": "string"
                    },
                    {
                        "internalType": "bytes",
                        "name": "data",
                        "type": "bytes"
                    },
                    {
                        "internalType": "uint256",
                        "name": "timestamp",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getAllMethodCalls",
                "outputs": [
                    {
                        "components": [
                            {
                                "internalType": "address",
                                "name": "caller",
                                "type": "address"
                            },
                            {
                                "internalType": "string",
                                "name": "methodName",
                                "type": "string"
                            },
                            {
                                "internalType": "bytes",
                                "name": "data",
                                "type": "bytes"
                            },
                            {
                                "internalType": "uint256",
                                "name": "timestamp",
                                "type": "uint256"
                            }
                        ],
                        "internalType": "struct DataToZeroAddress.MethodCall[]",
                        "name": "",
                        "type": "tuple[]"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "sender",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "string",
                        "name": "methodName",
                        "type": "string"
                    },
                    {
                        "indexed": false,
                        "internalType": "bytes",
                        "name": "data",
                        "type": "bytes"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "callIndex",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "timestamp",
                        "type": "uint256"
                    }
                ],
                "name": "DataStored",
                "type": "event"
            }
        ];

        // å…¨å±€å˜é‡
        let web3;
        let contract;
        let userAccount;
        let eventSubscription;
        let totalCalls = 0;

        // DOM å…ƒç´ 
        const elements = {
            debugInfo: document.getElementById('debugInfo'),
            checkConnectionBtn: document.getElementById('checkConnectionBtn'),
            resetConnectionBtn: document.getElementById('resetConnectionBtn'),
            walletIndicator: document.getElementById('walletIndicator'),
            walletStatus: document.getElementById('walletStatus'),
            connectWallet: document.getElementById('connectWallet'),
            loadContract: document.getElementById('loadContract'),
            testContractBtn: document.getElementById('testContractBtn'),
            contractStatus: document.getElementById('contractStatus'),
            dataInput: document.getElementById('dataInput'),
            gasLimitInput: document.getElementById('gasLimitInput'),
            storeDataBtn: document.getElementById('storeDataBtn'),
            simpleStoreBtn: document.getElementById('simpleStoreBtn'),
            estimateGasBtn: document.getElementById('estimateGasBtn'),
            storeResult: document.getElementById('storeResult'),
            indexInput: document.getElementById('indexInput'),
            getMethodCallBtn: document.getElementById('getMethodCallBtn'),
            getLatestBtn: document.getElementById('getLatestBtn'),
            methodCallResult: document.getElementById('methodCallResult'),
            getAllCallsBtn: document.getElementById('getAllCallsBtn'),
            refreshCallsBtn: document.getElementById('refreshCallsBtn'),
            allCallsResult: document.getElementById('allCallsResult'),
            startListeningBtn: document.getElementById('startListeningBtn'),
            stopListeningBtn: document.getElementById('stopListeningBtn'),
            clearEventsBtn: document.getElementById('clearEventsBtn'),
            eventsLog: document.getElementById('eventsLog')
        };

        // å·¥å…·å‡½æ•°
        function showStatus(element, message, type = 'info') {
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function updateDebugInfo(info) {
            const timestamp = new Date().toLocaleTimeString();
            elements.debugInfo.innerHTML = `[${timestamp}] ${info}`;
            console.log(`Debug: ${info}`);
        }

        function logEvent(message) {
            const timestamp = new Date().toLocaleTimeString();
            elements.eventsLog.innerHTML += `[${timestamp}] ${message}\n`;
            elements.eventsLog.scrollTop = elements.eventsLog.scrollHeight;
        }

        function formatTimestamp(timestamp) {
            return new Date(parseInt(timestamp) * 1000).toLocaleString('zh-CN');
        }

        function formatAddress(address) {
            return `${address.slice(0, 6)}...${address.slice(-4)}`;
        }

        function bytesToString(hexBytes) {
            try {
                // ç§»é™¤ 0x å‰ç¼€
                const hex = hexBytes.startsWith('0x') ? hexBytes.slice(2) : hexBytes;
                // è½¬æ¢ä¸ºå­—ç¬¦ä¸²
                let str = '';
                for (let i = 0; i < hex.length; i += 2) {
                    const byte = parseInt(hex.substr(i, 2), 16);
                    if (byte !== 0) { // è·³è¿‡ç©ºå­—èŠ‚
                        str += String.fromCharCode(byte);
                    }
                }
                return str || hexBytes; // å¦‚æœè½¬æ¢å¤±è´¥ï¼Œè¿”å›åŸå§‹hex
            } catch (error) {
                return hexBytes;
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                logEvent(`ğŸ“‹ å·²å¤åˆ¶åˆ°å‰ªè´´æ¿: ${formatAddress(text)}`);
            });
        }

        // æ£€æŸ¥è¿æ¥çŠ¶æ€
        async function checkConnection() {
            try {
                updateDebugInfo('æ£€æŸ¥è¿æ¥çŠ¶æ€...');

                if (!web3) {
                    updateDebugInfo('âŒ Web3 æœªåˆå§‹åŒ–');
                    return;
                }

                const accounts = await web3.eth.getAccounts();
                const chainId = await web3.eth.getChainId();
                const blockNumber = await web3.eth.getBlockNumber();
                const balance = userAccount ? await web3.eth.getBalance(userAccount) : '0';

                const info = `
âœ… è¿æ¥æ­£å¸¸<br>
ğŸ  è´¦æˆ·: ${userAccount ? formatAddress(userAccount) : 'æœªè¿æ¥'}<br>
ğŸŒ é“¾ID: ${chainId}<br>
ğŸ“¦ åŒºå—: ${blockNumber}<br>
ğŸ’° ä½™é¢: ${web3.utils.fromWei(balance, 'ether')} MON
                `;

                updateDebugInfo(info);

            } catch (error) {
                updateDebugInfo(`âŒ è¿æ¥æ£€æŸ¥å¤±è´¥: ${error.message}`);
            }
        }

        // é‡ç½®è¿æ¥
        async function resetConnection() {
            try {
                updateDebugInfo('é‡ç½®è¿æ¥ä¸­...');

                // æ¸…é™¤ç°æœ‰è¿æ¥
                web3 = null;
                contract = null;
                userAccount = null;

                // é‡æ–°è¿æ¥
                await connectWallet();

            } catch (error) {
                updateDebugInfo(`âŒ é‡ç½®å¤±è´¥: ${error.message}`);
            }
        }

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                updateDebugInfo('æ­£åœ¨è¿æ¥é’±åŒ…...');

                if (typeof window.ethereum !== 'undefined') {
                    web3 = new Web3(window.ethereum);

                    const accounts = await window.ethereum.request({
                        method: 'eth_requestAccounts'
                    });

                    userAccount = accounts[0];

                    // æ£€æŸ¥å¹¶åˆ‡æ¢ç½‘ç»œ
                    const chainId = await web3.eth.getChainId();
                    updateDebugInfo(`å½“å‰é“¾ID: ${chainId}`);

                    if (chainId !== 10143) {
                        updateDebugInfo('æ­£åœ¨åˆ‡æ¢åˆ° Monad æµ‹è¯•ç½‘...');
                        try {
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: '0x279F' }],
                            });
                        } catch (switchError) {
                            if (switchError.code === 4902) {
                                updateDebugInfo('æ·»åŠ  Monad æµ‹è¯•ç½‘...');
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: '0x279F',
                                        chainName: 'Monad Testnet',
                                        nativeCurrency: {
                                            name: 'MON',
                                            symbol: 'MON',
                                            decimals: 18
                                        },
                                        rpcUrls: ['https://testnet-rpc.monad.xyz'],
                                        blockExplorerUrls: ['https://testnet.monadexplorer.com/']
                                    }]
                                });
                            }
                        }
                    }

                    updateWalletStatus(true);
                    updateDebugInfo(`âœ… é’±åŒ…è¿æ¥æˆåŠŸ: ${formatAddress(userAccount)}`);

                    // è‡ªåŠ¨åŠ è½½åˆçº¦
                    await loadContract();

                } else {
                    throw new Error('è¯·å®‰è£… MetaMask é’±åŒ…');
                }
            } catch (error) {
                updateDebugInfo(`âŒ é’±åŒ…è¿æ¥å¤±è´¥: ${error.message}`);
                showStatus(elements.contractStatus, `è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ›´æ–°é’±åŒ…çŠ¶æ€
        function updateWalletStatus(connected) {
            if (connected) {
                elements.walletIndicator.classList.add('connected');
                elements.walletStatus.textContent = `å·²è¿æ¥: ${formatAddress(userAccount)}`;
                elements.connectWallet.textContent = 'å·²è¿æ¥';
                elements.connectWallet.disabled = true;
            } else {
                elements.walletIndicator.classList.remove('connected');
                elements.walletStatus.textContent = 'æœªè¿æ¥é’±åŒ…';
                elements.connectWallet.textContent = 'è¿æ¥ MetaMask';
                elements.connectWallet.disabled = false;
            }
        }

        // åŠ è½½åˆçº¦
        async function loadContract() {
            try {
                updateDebugInfo('æ­£åœ¨åŠ è½½åˆçº¦...');

                if (!web3) {
                    throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…');
                }

                contract = new web3.eth.Contract(contractABI, CONTRACT_ADDRESS);

                showStatus(elements.contractStatus, 'âœ… åˆçº¦åŠ è½½æˆåŠŸ!', 'success');
                updateDebugInfo(`âœ… åˆçº¦å·²åŠ è½½: ${formatAddress(CONTRACT_ADDRESS)}`);

                // å¯ç”¨æŒ‰é’®
                elements.storeDataBtn.disabled = false;
                elements.simpleStoreBtn.disabled = false;
                elements.estimateGasBtn.disabled = false;

            } catch (error) {
                updateDebugInfo(`âŒ åˆçº¦åŠ è½½å¤±è´¥: ${error.message}`);
                showStatus(elements.contractStatus, `åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•åˆçº¦è¿æ¥
        async function testContract() {
            try {
                updateDebugInfo('æµ‹è¯•åˆçº¦è¿æ¥...');

                if (!contract) {
                    throw new Error('åˆçº¦æœªåŠ è½½');
                }

                // å°è¯•è°ƒç”¨åªè¯»æ–¹æ³•
                const calls = await contract.methods.getAllMethodCalls().call();

                showStatus(elements.contractStatus, `âœ… åˆçº¦æµ‹è¯•æˆåŠŸ! å½“å‰æœ‰ ${calls.length} æ¡è®°å½•`, 'success');
                updateDebugInfo(`âœ… åˆçº¦æµ‹è¯•æˆåŠŸï¼Œè®°å½•æ•°: ${calls.length}`);

            } catch (error) {
                updateDebugInfo(`âŒ åˆçº¦æµ‹è¯•å¤±è´¥: ${error.message}`);
                showStatus(elements.contractStatus, `æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ä¼°ç®— Gas
        async function estimateGas() {
            try {
                const data = elements.dataInput.value.trim();
                if (!data) {
                    showStatus(elements.storeResult, 'è¯·è¾“å…¥è¦å­˜å‚¨çš„æ•°æ®', 'error');
                    return;
                }

                updateDebugInfo('æ­£åœ¨ä¼°ç®— Gas...');

                const dataBytes = web3.utils.asciiToHex(data);
                const gasEstimate = await contract.methods.storeData(dataBytes).estimateGas({
                    from: userAccount
                });

                const gasPrice = await web3.eth.getGasPrice();
                const gasCost = web3.utils.fromWei((BigInt(gasEstimate) * BigInt(gasPrice)).toString(), 'ether');

                elements.gasLimitInput.value = Math.ceil(gasEstimate * 1.2); // å¢åŠ 20%ä½™é‡

                showStatus(elements.storeResult,
                    `â›½ Gas ä¼°ç®—ç»“æœ:<br>
                    ä¼°ç®— Gas: ${gasEstimate}<br>
                    æ¨è Gas: ${Math.ceil(gasEstimate * 1.2)}<br>
                    é¢„ä¼°è´¹ç”¨: ${gasCost} MON`,
                    'info'
                );

                updateDebugInfo(`â›½ Gas ä¼°ç®—: ${gasEstimate} (æ¨è: ${Math.ceil(gasEstimate * 1.2)})`);

            } catch (error) {
                updateDebugInfo(`âŒ Gas ä¼°ç®—å¤±è´¥: ${error.message}`);
                showStatus(elements.storeResult, `Gas ä¼°ç®—å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ç®€å•å­˜å‚¨æ•°æ®
        async function simpleStoreData() {
            try {
                const data = elements.dataInput.value.trim() || "æµ‹è¯•æ•°æ®";

                updateDebugInfo('å¼€å§‹å­˜å‚¨æ•°æ®...');
                elements.simpleStoreBtn.disabled = true;
                elements.simpleStoreBtn.classList.add('loading');

                showStatus(elements.storeResult, 'æ­£åœ¨å‘é€äº¤æ˜“...', 'info');

                const dataBytes = web3.utils.asciiToHex(data);

                // ä½¿ç”¨è¾ƒä½çš„Gaså’Œç®€å•çš„äº¤æ˜“å‚æ•°
                const tx = await contract.methods.storeData(dataBytes).send({
                    from: userAccount,
                    gas: 200000,  // é™ä½Gasé™åˆ¶
                    gasPrice: web3.utils.toWei('20', 'gwei')  // è®¾ç½®è¾ƒä½çš„Gasä»·æ ¼
                });

                showStatus(elements.storeResult,
                    `âœ… æ•°æ®å­˜å‚¨æˆåŠŸ!<br>
                    äº¤æ˜“å“ˆå¸Œ: <a href="https://testnet.monadexplorer.com/tx/${tx.transactionHash}" target="_blank">${formatAddress(tx.transactionHash)}</a>`,
                    'success'
                );

                updateDebugInfo(`âœ… å­˜å‚¨æˆåŠŸ: "${data}" (Tx: ${formatAddress(tx.transactionHash)})`);
                elements.dataInput.value = '';

            } catch (error) {
                updateDebugInfo(`âŒ å­˜å‚¨å¤±è´¥: ${error.message}`);
                showStatus(elements.storeResult, `å­˜å‚¨å¤±è´¥: ${error.message}`, 'error');
                console.error('å­˜å‚¨é”™è¯¯è¯¦æƒ…:', error);
            } finally {
                elements.simpleStoreBtn.disabled = false;
                elements.simpleStoreBtn.classList.remove('loading');
            }
        }

        // é«˜çº§å­˜å‚¨æ•°æ®
        async function storeData() {
            try {
                const data = elements.dataInput.value.trim();
                const gasLimit = elements.gasLimitInput.value;

                if (!data) {
                    showStatus(elements.storeResult, 'è¯·è¾“å…¥è¦å­˜å‚¨çš„æ•°æ®', 'error');
                    return;
                }

                updateDebugInfo(`å¼€å§‹å­˜å‚¨æ•°æ®ï¼ŒGasé™åˆ¶: ${gasLimit}`);
                elements.storeDataBtn.disabled = true;
                elements.storeDataBtn.classList.add('loading');

                showStatus(elements.storeResult, 'æ­£åœ¨å‘é€äº¤æ˜“...', 'info');

                const dataBytes = web3.utils.asciiToHex(data);

                const tx = await contract.methods.storeData(dataBytes).send({
                    from: userAccount,
                    gas: parseInt(gasLimit)
                });

                showStatus(elements.storeResult,
                    `âœ… æ•°æ®å­˜å‚¨æˆåŠŸ!<br>
                    äº¤æ˜“å“ˆå¸Œ: <a href="https://testnet.monadexplorer.com/tx/${tx.transactionHash}" target="_blank">${formatAddress(tx.transactionHash)}</a>`,
                    'success'
                );

                updateDebugInfo(`âœ… å­˜å‚¨æˆåŠŸ: "${data}" (Tx: ${formatAddress(tx.transactionHash)})`);
                elements.dataInput.value = '';

            } catch (error) {
                updateDebugInfo(`âŒ å­˜å‚¨å¤±è´¥: ${error.message}`);
                showStatus(elements.storeResult, `å­˜å‚¨å¤±è´¥: ${error.message}`, 'error');
                console.error('å­˜å‚¨é”™è¯¯è¯¦æƒ…:', error);
            } finally {
                elements.storeDataBtn.disabled = false;
                elements.storeDataBtn.classList.remove('loading');
            }
        }

        // æŸ¥è¯¢å•ä¸ªæ–¹æ³•è°ƒç”¨
        async function getMethodCall() {
            try {
                const index = elements.indexInput.value.trim();
                if (index === '') {
                    showStatus(elements.methodCallResult, 'è¯·è¾“å…¥è°ƒç”¨ç´¢å¼•', 'error');
                    return;
                }

                const result = await contract.methods.getMethodCall(index).call();

                const caller = result[0];
                const methodName = result[1];
                const data = result[2];
                const timestamp = result[3];

                const displayData = bytesToString(data);

                elements.methodCallResult.innerHTML = `
                    <div class="method-call-item">
                        <h4>ğŸ“ æ–¹æ³•è°ƒç”¨ #${index}</h4>
                        <div class="method-detail"><strong>è°ƒç”¨è€…:</strong> ${caller} <button class="copy-btn" onclick="copyToClipboard('${caller}')">å¤åˆ¶</button></div>
                        <div class="method-detail"><strong>æ–¹æ³•å:</strong> ${methodName}</div>
                        <div class="method-detail"><strong>æ•°æ®:</strong> ${displayData}</div>
                        <div class="method-detail"><strong>åŸå§‹æ•°æ®:</strong> ${data}</div>
                        <div class="method-detail"><strong>æ—¶é—´æˆ³:</strong> ${formatTimestamp(timestamp)}</div>
                    </div>
                `;

                logEvent(`ğŸ” æŸ¥è¯¢è°ƒç”¨ #${index}: "${displayData}"`);

            } catch (error) {
                console.error('æŸ¥è¯¢å¤±è´¥:', error);
                showStatus(elements.methodCallResult, `æŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æŸ¥è¯¢æœ€æ–°è°ƒç”¨
        async function getLatestCall() {
            if (totalCalls > 0) {
                elements.indexInput.value = totalCalls - 1;
                await getMethodCall();
            } else {
                showStatus(elements.methodCallResult, 'æš‚æ— è°ƒç”¨è®°å½•', 'info');
            }
        }

        // è·å–æ‰€æœ‰æ–¹æ³•è°ƒç”¨
        async function getAllMethodCalls() {
            try {
                const result = await contract.methods.getAllMethodCalls().call();
                totalCalls = result.length;

                if (result.length === 0) {
                    elements.allCallsResult.innerHTML = '<div class="status info">æš‚æ— æ–¹æ³•è°ƒç”¨è®°å½•</div>';
                    return;
                }

                let html = `<div class="status success">å…±æ‰¾åˆ° ${result.length} æ¡è°ƒç”¨è®°å½•</div>`;

                // å€’åºæ˜¾ç¤ºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
                result.slice().reverse().forEach((call, reverseIndex) => {
                    const actualIndex = result.length - 1 - reverseIndex;
                    const displayData = bytesToString(call.data);
                    html += `
                        <div class="method-call-item">
                            <h4>ğŸ“ è°ƒç”¨ #${actualIndex} ${reverseIndex === 0 ? '(æœ€æ–°)' : ''}</h4>
                            <div class="method-detail"><strong>è°ƒç”¨è€…:</strong> ${call.caller} <button class="copy-btn" onclick="copyToClipboard('${call.caller}')">å¤åˆ¶</button></div>
                            <div class="method-detail"><strong>æ–¹æ³•å:</strong> ${call.methodName}</div>
                            <div class="method-detail"><strong>æ•°æ®:</strong> ${displayData}</div>
                            <div class="method-detail"><strong>æ—¶é—´æˆ³:</strong> ${formatTimestamp(call.timestamp)}</div>
                        </div>
                    `;
                });

                elements.allCallsResult.innerHTML = html;
                logEvent(`ğŸ“‹ è·å–åˆ° ${result.length} æ¡è°ƒç”¨è®°å½•`);

            } catch (error) {
                console.error('è·å–è°ƒç”¨è®°å½•å¤±è´¥:', error);
                showStatus(elements.allCallsResult, `è·å–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å¼€å§‹ç›‘å¬äº‹ä»¶
        async function startListening() {
            try {
                if (eventSubscription) {
                    eventSubscription.unsubscribe();
                }

                eventSubscription = contract.events.DataStored()
                    .on('data', function (event) {
                        const { sender, methodName, data, callIndex, timestamp } = event.returnValues;
                        const displayData = bytesToString(data);
                        logEvent(`ğŸ“¡ æ–°äº‹ä»¶: ${methodName} | å‘é€è€…: ${formatAddress(sender)} | æ•°æ®: "${displayData}" | ç´¢å¼•: ${callIndex}`);

                        // è‡ªåŠ¨åˆ·æ–°è°ƒç”¨åˆ—è¡¨
                        setTimeout(() => getAllMethodCalls(), 1000);
                    })
                    .on('error', function (error) {
                        logEvent(`âŒ äº‹ä»¶ç›‘å¬é”™è¯¯: ${error.message}`);
                    });

                elements.startListeningBtn.disabled = true;
                elements.stopListeningBtn.disabled = false;
                logEvent('ğŸ§ å¼€å§‹ç›‘å¬ DataStored äº‹ä»¶...');

            } catch (error) {
                console.error('å¼€å§‹ç›‘å¬å¤±è´¥:', error);
                logEvent(`âŒ ç›‘å¬å¤±è´¥: ${error.message}`);
            }
        }

        // åœæ­¢ç›‘å¬äº‹ä»¶
        function stopListening() {
            if (eventSubscription) {
                eventSubscription.unsubscribe();
                eventSubscription = null;
            }

            elements.startListeningBtn.disabled = false;
            elements.stopListeningBtn.disabled = true;
            logEvent('ğŸ›‘ å·²åœæ­¢äº‹ä»¶ç›‘å¬');
        }

        // æ¸…é™¤äº‹ä»¶æ—¥å¿—
        function clearEvents() {
            elements.eventsLog.innerHTML = '';
            logEvent('ğŸ“¡ äº‹ä»¶æ—¥å¿—å·²æ¸…é™¤');
        }

        // äº‹ä»¶ç»‘å®š
        elements.checkConnectionBtn.addEventListener('click', checkConnection);
        elements.resetConnectionBtn.addEventListener('click', resetConnection);
        elements.connectWallet.addEventListener('click', connectWallet);
        elements.loadContract.addEventListener('click', loadContract);
        elements.testContractBtn.addEventListener('click', testContract);
        elements.estimateGasBtn.addEventListener('click', estimateGas);
        elements.simpleStoreBtn.addEventListener('click', simpleStoreData);
        elements.storeDataBtn.addEventListener('click', storeData);
        elements.getMethodCallBtn.addEventListener('click', getMethodCall);
        elements.getLatestBtn.addEventListener('click', getLatestCall);
        elements.getAllCallsBtn.addEventListener('click', getAllMethodCalls);
        elements.refreshCallsBtn.addEventListener('click', getAllMethodCalls);
        elements.startListeningBtn.addEventListener('click', startListening);
        elements.stopListeningBtn.addEventListener('click', stopListening);
        elements.clearEventsBtn.addEventListener('click', clearEvents);

        // å›è½¦é”®å¿«æ·æ“ä½œ
        elements.dataInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                storeData();
            }
        });

        elements.indexInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                getMethodCall();
            }
        });

        // åˆå§‹åŒ–æ—¥å¿—
        logEvent('ğŸš€ DataToZeroAddress åˆçº¦æµ‹è¯•é¡µé¢å·²åŠ è½½');
        logEvent(`ğŸ“„ åˆçº¦åœ°å€: ${CONTRACT_ADDRESS}`);
        logEvent('ğŸ’¡ è¯·è¿æ¥ MetaMask é’±åŒ…å¼€å§‹æµ‹è¯•');

        // æ£€æŸ¥æ˜¯å¦å·²è¿æ¥é’±åŒ…
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.request({ method: 'eth_accounts' })
                .then(accounts => {
                    if (accounts.length > 0) {
                        web3 = new Web3(window.ethereum);
                        userAccount = accounts[0];
                        updateWalletStatus(true);
                        logEvent(`ğŸ”— æ£€æµ‹åˆ°å·²è¿æ¥çš„é’±åŒ…: ${formatAddress(userAccount)}`);
                        loadContract();
                    }
                });
        }
    </script>
</body>

</html>